name: PROJECT GCP BUILD AND DEPLOY

on:
push:
branches: -project_deploy

jos:
build:
defaults:
run:
 working-directory: ./project

 runs-on: ubuntu-latest

 strategy:
 matrix:
 node-version: [16.x]

steps:
-uses: actions/checkout@v2
 with:
   persist-credentials: false

-name: Use Node.js ${{ matrix.node-version}}
uses: actions/setup-node@v1
with:
node-version: ${{ matrix.node-version }}

- name: 'configure GCP credentials'
 uses: google-github-actions/auth@v0
 with: 
  project_id: ${{env.PROJECT_ID}}
  credentials_json: '${{ secrets.GCP_project_credentials}}'
  export_default_credentials: true

  - name: Authorize docker push
   run: gcloud auth configure-docker

   - name: Build Container
   run:
    docker build -t gcr.io/${{env.PROJECT_ID}}/ ${{env.SERVICE}}:${{github.sha}}

   - name: Push container 
   run: docker build -t gcr.io/${{env.PROJECT_ID}}/ ${{env.SERVICE}}:${{github.sha}}

   - name: deploy to cloud run
   id: deploy
   uses : google-github-actions/deploy-cloudrun@v0
   with:
    service: ${{env.SERVICE}}
    image: docker build -t gcr.io/${{env.PROJECT_ID}}/ ${{env.SERVICE}}:${{github.sha}}
    region: ${{env.REGION}}

    - name: Show output
      run: echpo ${{steps.deploy.outputs,url }}

      env:
         PROJECT_ID: ${{ secrets.GCP_PROJECT}}
         SERVICE: project_deploy

 